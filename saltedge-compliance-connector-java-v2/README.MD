# Salt Edge Compliance Connector Java Example & SDK (v2)

This codebase is a full-stack application built on Spring Boot Framework.  
Is designated to demonstrate (simulate) communication between ASPSP/Bank and TPP/Client.  
_This application is just a Proof Of Concept._  
[See how to setup application](#Example-Application-Quick-Setup).
  
This codebase contains SDK module which is the set of tools for simplification of communication between ASPSP/Bank and Priora PSD2 Compliance Solution.    
The SDK module implements the Priora Connector v2 API compatible with **Berlin Group NextGenPSD2 XS2A API**.
[See how to add SDK](#SDK-Integration)  
**Last stable version of SDK library is "2.3.3".**
  
### Codebase consists of modules:
* **example** - simulates work of ASPSP/Bank Application.  
* **saltedge-connector-sdk** - set of tools for integration in existing Spring Applications.   
  
## Application Requirements
  
1. JDK, at least version 8 
1. Spring Boot Framework, at least version 2.2.+
1. Registration & API Keys  
   Follow the guide on how to [register and add API keys](https://priora.saltedge.com/connector-docs#registration-api-keys)

## Example Application Quick Setup

1. Clone project
1. Navigate to project's root folder
    ```bash
    cd saltedge-compliance-connector-java
    ```
1. Create configuration files
    ```bash
    cp example/src/main/resources/application.example.yml example/src/main/resources/application.yml
    cp example/src/main/resources/application.example.properties example/src/main/resources/application.properties
    ```
1. Add secret keys  
    You can generate your RSA key pair using this commands: 
    ```bash
    openssl genrsa -out connector_private_prod.pem 2048
    openssl rsa -pubout -in connector_private_prod.pem -out connector_public_prod.pem
    ```
   > Notice that you must save the content of `connector_public_prod.pem` in your Provider [Dashboard/Settings](https://priora.saltedge.com/providers/settings).
   
   After following the step above, be sure to save your private key generated by openssl in `example/src/main/resources` folder.  
1. Edit configuration files  
    * Example application uses a H2 in memory database (for now), can be changed easily in the `application.properties` for any other database type.
    * Set your external host name in `application.properties`
      ```yaml
      app.url=http://123456789.ngrok.io
      ```
1. Set your external host name in `application.properties`
  ```yaml
  app.url=http://my_host.org
  ``` 

## SDK Integration  

Target application should be compatible with [following requirements](#Application-Requirements)

### 1. Add SDK to target application
#### Add as project module
  1. Fork this repository
  2. In IntelliJ IDE Import module `File/New/Import Module...` in your project
  3. Build and run application on target device or emulator
#### Add as JAR library
  copy jar file `saltedge-connector-sdk-x.x.x-all.jar` 
  from from `https://github.com/saltedge/compliance-examples/tree/master/saltedge-compliance-connector-java-v2/out/`
  to your project
#### Add as Maven dependency  
  Add Salt Edge maven repository to application's build.gradle
  ```groovy
      repositories {
          maven {
              url 'https://raw.github.com/saltedge/compliance-examples/master/maven-repo/'
          }
      }
  ```
  Add Connector SDK dependency to application build.gradle
  ```groovy
      implementation ('com.saltedge.connector.sdk:saltedge-connector-sdk:x.x.x') {
          transitive = true
      }
  ```
    
### 2. Setup application as [described before](#example-application-quick-setup)

### 3. Add SDK package (`com.saltedge.connector.sdk`) to component scan annotation in Application class.
    ```java
    @SpringBootApplication(scanBasePackages = {CURRENT_APP_PACKAGE, SDKConstants.CONNECTOR_PACKAGE})
    @EnableJpaRepositories(basePackages = {CURRENT_APP_PACKAGE, SDKConstants.CONNECTOR_PACKAGE})
    @EntityScan(basePackages = {CURRENT_APP_PACKAGE, SDKConstants.CONNECTOR_PACKAGE})
    public class ExampleApplication {
       
    }
    ```
    
### 4. Add `extra` field to `Payment` entity.
  Add `extra` field (if not exist) for storing extra data from Salt Edge Compliance solution (e.g. prioraPaymentId).
  The Connector will transmit extra data on Payment creation and require it back at the end of the Payment authentication.
  
### 5. Create a service designated for providing information to and receiving events from `Salt Edge PSD2 Compliance`:
  This service should implement `ProviderServiceAbs` interface and should have `@Service` annotation because it is auto-wired in SDK;  
  
  * `getAuthorizationTypes(...)` - return list of registered [Authorization types](https://priora.saltedge.com/providers/settings#authorization_types);
  * `getExchangeRates()` - return list of Exchange rates for today;
  * `getAccountInformationAuthorizationPageUrl(...)` - return URL of authorization page for oAuth authorization of User and consent for accounts information;
  * `getAccountsOfUser(...)` - return accounts list of User;
  * `getTransactionsOfAccount(...)` - return transactions list for account of User;
  * `getCardAccountsOfUser(...)` - return list of card accounts of User;
  * `getTransactionsOfCardAccount(...)` - return list of transactions of card account of User;
  * `createPayment(...)` - create a payment order and return payment id or null
  * `getPaymentAuthorizationPageUrl(...)` - return URL of authorization page for payment;  
   
### 6. Use Connector's SDK callback service `ConnectorSDKCallbackService` for callback communication (e.g. notifying SDK about events):

  * `isUserConsentRequired(sessionSecret)` - check if User Consent (Bank Offered Consent) is required for authorization session determined by sessionSecret:
    - `sessionSecret` - unique authorization secret code passed to application via `getAccountInformationAuthorizationPageUrl(...)`;

  * `onAccountInformationAuthorizationSuccess(sessionSecret, userId, accessToken, consents)` - notify SDK about the successful authorization if User for AIS flow:  
    - `sessionSecret` - unique authorization secret code passed to application via `getAccountInformationAuthorizationPageUrl(...)`;       - `userId` - unique identifier of Provider's system User (Customer);  
    - `accessToken` - unique access identifier;  
    - `consents` - ProviderOfferedConsents object with user consent to provide account information;  

  * `onAccountInformationAuthorizationFail(sessionSecret)`- notify SDK about the failed authorization:  
    - `sessionSecret` - unique authorization secret code passed to application via `getAccountInformationAuthorizationPageUrl(...)`;
      
  * `onPaymentInitiationAuthorizationSuccess(paymentId, userId, extra)` - notify SDK about the successful authorization if User for AIS flow:  
    - `paymentId` - unique payment id;  
    - `userId` - unique identifier of Provider's system User (Customer);  
    - `extra` - extra data from authenticated Payment passed to application via `getPaymentAuthorizationPageUrl(...)`;  

    * `onPaymentInitiationAuthorizationFail(paymentId, extra)`- notify SDK about the failed authorization:  
    - `paymentId` - unique payment id;
    - `extra` - extra data from authenticated Payment passed to application via `getPaymentAuthorizationPageUrl(...)`;
      
  * `revokeAccountInformationConsent(userId, accessToken)`- Revoke Account information consent associated with userId and accessToken;  
  
  
## [Api Documentation](https://priora.banksalt.com/docs/aspsp/v2)
  
---
## [LICENSE](LICENSE.txt)

---
Copyright Â© 2020 Salt Edge. https://www.saltedge.com